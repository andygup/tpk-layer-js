<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>TPKLayer</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
        #header-div{
            font-family: helvetica, serif;
            position: relative;
            background: #000000;
            color: #ffffff;
            width: 100%;
            height: 50px;
            display:inline-block;
            vertical-align:middle;
            line-height: 50px;
            padding-left: 8px;
        }
        #header-title{
            position: relative;
            float: right;
            padding-right: 15px;
        }
        #loader-gif{
            display: block;
            visibility: hidden;
            position: relative;
            float: left;
            padding-left: 50%;
            padding-top: 25%;
            z-index: 10;
        }
        #map{
            position: absolute;
            left: 0;
            z-index: 1;
        }
        /* Portrait */
        @media screen and (orientation:portrait) {
            #loader-gif{
                display: block;
                visibility: hidden;
                position: relative;
                float: left;
                padding-left: 50%;
                padding-top: 25%;
                z-index: 10;
            }
        }

        /* Landscape */
        @media screen and (orientation:landscape) {
            #loader-gif{
                display: block;
                visibility: hidden;
                position: relative;
                float: left;
                padding-left: 50%;
                padding-top: 25%;
                z-index: 10;
            }
        }

    </style>
</head>

<body>
<div id="header-div">
    <input type="file" id="file-input" name="files[]" accept="application/zip" >Rename your .tpk file to .zip</input>
    <div id="header-title">TPKLayer demo</div>
</div>
<img id="loader-gif" src="images/loading.gif"/>
<div id="map"></div>

<script>
    var locationPath = location.pathname.replace(/\/[^/]+$/, "");
    var dojoConfig = {
        paths: {
            tpk: locationPath  + "lib/tpk",
            tiles: "//esri.github.io/offline-editor-js/lib/tiles"
        }
    }
</script>
<script src="lib/shim/IndexedDBShim.min.js"></script>
<script src="http://js.arcgis.com/3.9/"></script>
<script>
    var map;
    var fileInput,tpkLayer;

    require(["esri/map","tpk/TPKLayer","tpk/zip","dojo/on","dojo/domReady!"],
            function(Map,TPKLayer) {

                fileInput = document.getElementById("file-input");
                fileInput.addEventListener('change', function() {
                    console.log("File success");

                    zip.createReader(new zip.BlobReader(fileInput.files[0]), function(zipReader) {
                        zipReader.getEntries(function(entries){

                            var loading = dojo.byId("loader-gif");

                            tpkLayer = new TPKLayer(entries);
                            tpkLayer.on("progress",function(evt){
                                evt.total == evt.loaded ? loading.style.visibility = "hidden" : loading.style.visibility = "visible";
                                console.log("Total " + evt.total + ", loaded: " + evt.loaded + ", vis " + loading.style.visibility)
                            })

                            map = new Map("map");
                            map.addLayer(tpkLayer);


                        },function(err){
                            alert("There was a problem reading the file!: " + err);
                        })

                    })
                },false);
            }
    );
</script>
</body>
</html>