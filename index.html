<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Simple Map</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
        #header-div{
            font-family: helvetica, serif;
            position: relative;
            background: #000000;
            color: #ffffff;
            width: 100%;
            height: 50px;
            display:inline-block;
            vertical-align:middle;
            line-height: 50px;
            padding-left: 8px;
        }
    </style>
</head>

<body>
    <div id="header-div">
        <input type="file" id="file-input" name="files[]" multiple />
    </div>
    <div id="map"></div>

    <script>
        var locationPath = location.pathname.replace(/\/[^/]+$/, "");
        var dojoConfig = {
            paths: {
                utils: locationPath  + "/utils"
            }
        }
    </script>
    <script type="text/javascript" src="lib/zip.js"></script>
    <script src="http://js.arcgis.com/3.9/"></script>
    <script>
        var map,basemapLayer;
        var fileInput;
        var tpkEntries,fullExtent,spatialReference,unzip;

        require(["esri/map","utils/TPKLayer",
            "dojo/_base/lang","dojo/_base/declare","dojox/encoding/base64","esri/geometry/Extent","esri/layers/ArcGISTiledMapServiceLayer", "dojo/domReady!"],
            function(Map,TPKLayer,lang,declare,base64,Extent,ArcGISTiledMapServiceLayer) {
                TPKLayer = new TPKLayer();

                fileInput = document.getElementById("file-input");
                fileInput.addEventListener('change', function() {
                    console.log("File success");

                    zip.createReader(new zip.BlobReader(fileInput.files[0]), function(zipReader) {
                        zipReader.getEntries(function(entries){
                            TPKLayer.setTPKTiles(entries,function(evt){
                                if(evt){
                                    map = new Map("map", {
                                        //basemap: "satellite",
                                        //center: [-122.45, 37.75], // longitude, latitude
                                        extent: TPKLayer._extent
                                        //zoom: 13
                                    });

                                    map.on("load",init);
                                    var tiles = new ArcGISTiledMapServiceLayer("http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer");
                                    map.addLayer(tiles);
                                }
                            });

                        })

                    })
                },false);

                function init(){
                    if (!window.File && !window.FileReader && !window.FileList && !window.Blob) {
                        alert("Your browser does not support reading tpk files.");
                        return;
                    } else {
                        console.log("TPKs supported!")
                    }

                    basemapLayer = map.getLayer( map.layerIds[0] );
                    TPKLayer.extend(basemapLayer,function(success){
                        console.log("success= " + success);
                    })
                }

                function onerror(message) {
                    alert(message);
                }
            }
        );
    </script>
</body>
</html>